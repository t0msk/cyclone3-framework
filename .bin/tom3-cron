#!/usr/bin/perl
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use Term::ANSIColor;

BEGIN
{
	require "/www/TOM/.bin/tom3-init";
	use Inline (Config => DIRECTORY => "/www/TOM/.core/.libs/_Inline");
}

use TOM;
use enc3;
use iconv;
use Mysql;
use TOM::Database::connect;
use Time::HiRes qw( usleep ualarm gettimeofday tv_interval );
use CRON;
use CRON::debug;


package main;

$TOM::engine_ready=1;


%form=
(
 '-v'			=>	"verbosity",
 '--domain'	=>	"cron domain",
 '---global'		=>	"cron global",
 '---category'	=>	"cron category",
 '---name'		=>	"cron name",
);
if ((!$FORM{-name}) || ($FORM{h})||($FORM{help})){&help();}

print color 'reset bold blue';

require "/www/TOM/.core/_config/cron.conf";

$cron::P=$CRON::P;
$main::time_current=$cron::time_current=time;
local (
	$cron::Tsec,
	$cron::Tmin,
	$cron::Thour,
	$cron::Tmday,
	$cron::Tmom,
	$cron::Tyear,
	$cron::Twday,
	$cron::Tyday,
	$cron::Tisdst) = localtime($cron::time_current);
   # doladenie casu
   $cron::Tyear+=1900;$cron::Tmom++;
   # formatujem cas
   local (
   	$cron::Fsec,
	$cron::Fmin,
	$cron::Fhour,
	$cron::Fmday,
	$cron::Fmom,
	$cron::Fyear,
	$cron::Fwday,
	$cron::Fyday,
	$cron::Fisdst
	) = (
	sprintf ('%02d', $cron::Tsec),
	sprintf ('%02d', $cron::Tmin),
	sprintf ('%02d', $cron::Thour),
	sprintf ('%02d', $cron::Tmday),
	sprintf ('%02d', $cron::Tmom),
	$cron::Tyear,
	$cron::Twday,
	$cron::Tyday,
	$cron::Tisdst
	);
	
	
local (
	$main::Tsec,
	$main::Tmin,
	$main::Thour,
	$main::Tmday,
	$main::Tmom,
	$main::Tyear,
	$main::Twday,
	$main::Tyday,
	$main::Tisdst) = localtime($main::time_current);
   # doladenie casu
   $main::Tyear+=1900;$main::Tmom++;
   # formatujem cas
   local (
   	$main::Fsec,
	$main::Fmin,
	$main::Fhour,
	$main::Fmday,
	$main::Fmom,
	$main::Fyear,
	$main::Fwday,
	$main::Fyday,
	$main::Fisdst
	) = (
	sprintf ('%02d', $main::Tsec),
	sprintf ('%02d', $main::Tmin),
	sprintf ('%02d', $main::Thour),
	sprintf ('%02d', $main::Tmday),
	sprintf ('%02d', $main::Tmom),
	$main::Tyear,
	$main::Twday,
	$main::Tyday,
	$main::Tisdst
	);
	$main::Fyear_sub=$main::Fyear;
	$main::Fyear_sub=~s/^..//;
	
	$TOM::engine="cron";
	
	$CRON::P="/www/TOM";
	$cron::P=$CRON::P;
	
	if ($FORM{domain})
	{
		main::_log("loading $main::p/local.conf");
		require $main::p."/local.conf";
		$cron::P=$main::p;
		$tom::P=$main::p;
	}
	else
	{
		$TOM::DB{'main'}{'name'}="TOM";
	}
	
	TOM::Database::connect::multi('main');
	
	print "";
	
	module(%FORM);
	
	
	&exit();
