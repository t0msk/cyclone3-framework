#!/bin/perl
# áéíóú - USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use Secure::form;
use strict;


sub execute
{
 my %env=@_;
 Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN
 #Tomahawk::GetXLNG() || return undef; # NATIAHNEM XML LANGUAGE

 $env{max}=10 unless $env{max};
 $env{page}=$main::FORM{a400mlistpage};$env{page}=0 unless $env{page};
 $env{from}=$env{page}*$env{max};
 $env{to}=$env{max}+1;

 $env{URL}="?|?" unless $env{URL};

 $env{db_400}=Tomahawk::Getmdlvar("400","db") unless $env{db_400};
 $env{db_400}=$TOM::DB_name unless $env{db_400};

 $env{db_500}=Tomahawk::Getmdlvar("500","db") unless $env{db_500};
 $env{db_500}=$TOM::DB_name unless $env{db_500};

 $env{format_500}='t' unless $env{format_500};
 $env{$env{format_500}.'_hash'}=Tomahawk::Getmdlvar("500",$env{format_500}.'_hash',db=>$env{db_500});

 #$env{keywords}=~s| |,|g;

 #Secure::form::convert($env{keywords});
 main::_log("searching string ".$env{keywords});
 #my $var=$env{keywords};
 #Secure::form::convert($var);
 #main::_log("modifying ".$var);

 #my $var=$env{keywords};
 #Secure::form::convert($var);
 #main::_log("modifying ".$var);

 #$env{keywords}=~s| |\+|g;
 Secure::form::convert($env{keywords});
 main::_log("modifying ".$env{keywords});

 #$XSGN{TMP}="<textarea>".$env{keywords}."</textarea>";return 1;

 # OSETRENIE WHERE
 #if (($env{where})&&(not $env{where}=~/^and/i)){$env{where}="AND ".$env{where}}

 # ORDER BY
 #
 # TODO: [Aben] pridat order by match_av
 #
 $env{orderby}="match_av DESC" unless $env{orderby};
 $env{where}="";


#=head1
 foreach (split(',',$env{keywords}))
 {
  #$env{where}.="(title LIKE '%$_%' OR tiny LIKE '%$_%' OR full LIKE '%$_%') AND ";
  $env{where}.="full LIKE '%$_%' AND ";
 }
#=cut
 #$env{where}="MATCH(full,tiny,subtitle,title) AGAINST ('".$env{keywords}."') AND";
 $env{where}="MATCH(full,tiny,subtitle,title) AGAINST ('".$env{keywords}."' IN BOOLEAN MODE)";
 #$env{where}="MATCH(full) AGAINST ('".$env{keywords}."') AND";

 if (!$main::FORM{a400mlistpages})
 {
  my $db0=$main::DBH->Query("
	(SELECT COUNT(*)
	FROM $env{db_400}.a400
	WHERE	$env{where}
		AND starttime<$tom::time_current
		AND (endtime>$tom::time_current OR endtime=0)
		AND active='Y'
		AND (lng='$env{lng}' OR lng=''))
	UNION ALL
	(SELECT COUNT(*)
	FROM $env{db_400}.a400_arch
	WHERE	$env{where}
		AND starttime<$tom::time_current
		AND (endtime>$tom::time_current OR endtime=0)
		AND active='Y'
		AND (lng='$env{lng}' OR lng=''))");
  while (my @db0_line=$db0->FetchRow())
  {
   $main::FORM{a400mlistpages}+=$db0_line[0];
  }
  $main::FORM{a400mlistno}=$main::FORM{a400mlistpages};
  if ($main::FORM{a400mlistpages}/$env{max} ne int($main::FORM{a400mlistpages}/$env{max}))
  {
   $main::FORM{a400mlistpages}=int($main::FORM{a400mlistpages}/$env{max})+1;
  }
  else
  {
   $main::FORM{a400mlistpages}=int($main::FORM{a400mlistpages}/$env{max});
  }
 }



 my $db0=$main::DBH->Query("
	(SELECT ID,IDcategory,title,subtitle,tiny,xrelated,link,starttime,priority,xrelated,full,
		$env{where} AS match_av
	FROM $env{db_400}.a400
	WHERE	$env{where}
		AND starttime<$tom::time_current
		AND (endtime>$tom::time_current OR endtime=0)
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	ORDER BY $env{orderby})
	UNION ALL
	(SELECT ID,IDcategory,title,subtitle,tiny,xrelated,link,starttime,priority,xrelated,full,
		$env{where} AS match_av
	FROM $env{db_400}.a400_arch
	WHERE	$env{where}
		AND starttime<$tom::time_current
		AND (endtime>$tom::time_current OR endtime=0)
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	ORDER BY $env{orderby})
	ORDER BY $env{orderby} LIMIT $env{from},$env{to}");
 $env{to}=$db0->NumRows();
 while ((my %db0_line=$db0->FetchHash())&&($env{views}<$env{max}))
 {
  $env{views}++;
  #$tom::ERR="page: $env{max}: $env{views}";return undef;
  # TU BY SOM MOZNO MAL ZACAT POCITAT S archivom
  my $var=$db0_line{ID};
  if ($db0_line{link})
  {
   my $db0=$main::DBH->Query("
	(SELECT ID,IDcategory,title,subtitle,tiny,xrelated,link,xrelated,full,
		$env{where} AS match_av
	FROM $env{db_400}.a400
	WHERE	ID='$var'
		AND starttime<$tom::time_current
		AND ((endtime>$tom::time_current) OR (endtime='0'))
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	LIMIT 1)
	UNION ALL
	(SELECT ID,IDcategory,title,subtitle,tiny,xrelated,link,xrelated,full,
		$env{where} AS match_av
	FROM $env{db_400}.a400_arch
	WHERE	ID='$var'
		AND starttime<$tom::time_current
		AND ((endtime>$tom::time_current) OR (endtime='0'))
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	LIMIT 1)
	LIMIT 1");
   if (%db0_line=$db0->fetchhash())
   {
    #Tomahawk::debug::log(9,"link $var=$db0_line{ID}");
   }
   else {$tom::ERR="k clanku $var som nenasiel fcnu linku :(";return undef;}
  }


  $XSGN{NULL}=$XSGN{LINE};

  
  $XSGN{NULL}=~s|<%ID%>|$db0_line{ID}|g;

  if (($env{title_cut})&&(length($db0_line{title})>$env{title_cut}))
  {$db0_line{title}=substr($db0_line{title}, 0, $env{title_cut});$db0_line{title}=~s|(.*) .*?$|$1 ...|;}
  $XSGN{NULL}=~s|<%TITLE%>|$db0_line{title}|g;

  
  
	if ((!$db0_line{tiny})&&($db0_line{full}))
	{
		$db0_line{tiny}=$db0_line{full};
		$db0_line{tiny}=~s|<.*?>||g;
		#$db_line{tiny}="test";
	}
	
	if
	(
		(
			($env{tiny_cut})&&(length($db0_line{tiny})>$env{tiny_cut})
		)
		||	(length($db0_line{tiny})>250)
	)
	{
		$env{tiny_cut}=250 unless $env{tiny_cut};
		$db0_line{tiny}=substr($db0_line{tiny}, 0, $env{tiny_cut});$db0_line{tiny}=~s|(.*) .*?$|$1&hellip;|;
	}
    
  #if (($env{tiny_cut})&&(length($db0_line{tiny})>$env{tiny_cut}))
  #{$db0_line{tiny}=substr($db0_line{tiny}, 0, $env{tiny_cut});$db0_line{tiny}=~s|(.*) .*?$|$1 ...|;}
  $XSGN{NULL}=~s|<%TINY%>|$db0_line{tiny}|g;

  if (($env{subtitle_cut})&&(length($db0_line{subtitle})>$env{subtitle_cut}))
  {$db0_line{subtitle}=substr($db0_line{subtitle}, 0, $env{subtitle_cut});$db0_line{subtitle}=~s|(.*) .*?$|$1 ...|;}
  $XSGN{NULL}=~s|<%SUBTITLE%>|$db0_line{subtitle}|g;

  my $zeroid;
#  if ($db0_line{xrelated}=~/<VAR id="a500" value="(.*?)" \/>/)
#  {$zeroid=sprintf('%07d',$1);} else {$zeroid=sprintf('%07d',0);}
#  $zeroid=~/^(....)/i;my $var=$1;

  if ($db0_line{xrelated}=~/<VAR id="a500" value="(.*?)" \/>/)
  {$zeroid=sprintf('%07d',$1);} else {$zeroid=sprintf('%07d',0);}
  my $var;if ($zeroid=~/^(....)/i){$var=$1};

#  if ($env{$env{format_500}.'_hash'})
  if (($env{$env{format_500}.'_hash'})&&($zeroid ne "0000000"))
  {
   my $db0=$main::DBH->Query("
   	SELECT hash FROM $env{db_500}.a500
   	WHERE	ID='$zeroid'
		AND format='$env{format_500}'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
   if (my @db0_line=$db0->fetchrow)
   {$zeroid=$db0_line[0];
    #Tomahawk::debug::log(9,"hash $var/$zeroid-$env{format_500}.jpg");
   }
   else
   {
    #Tomahawk::debug::log(9,"not hash $var/$zeroid-$env{format_500}.jpg");
   }
  }
  $XSGN{NULL}=~s|<%IMG%>|$tom::H_500/$var/$zeroid-$env{format_500}.jpg|g;

  # DATE & TIME
  if ($env{show_datetime})
  {
   my %env0=Utils::datetime::ctodatetime($db0_line{starttime},format=>1);
   if ($env{show_datetime} eq "1")
   {$XSGN{NULL}=~s|<%DATETIME%>|$env0{mday}.$env0{mom}.$env0{year} $env0{hour}:$env0{min}|g;}
   else
   {
    $XSGN{NULL}=~s|<%DAY%>|$env0{mday}|g;
    $XSGN{NULL}=~s|<%MONTH%>|$env0{mom}|g;
    $XSGN{NULL}=~s|<%YEAR%>|$env0{year}|g;
    $XSGN{NULL}=~s|<%HOUR%>|$env0{hour}|g;
    $XSGN{NULL}=~s|<%MINUTE%>|$env0{min}|g;
   }
  }

  # LUBOVOLNE PRIDANIE RELATED
  if ($env{xrelated})
  {
   #Tomahawk::debug::log(8,"mam xrelated");
   while ($db0_line{xrelated}=~s|<VAR id="(.*?)" value="(.*?)" />||si)
  {#next unless $1;next unless $2;
   my ($var,$null)=($1,$2);
   if ($XSGN{$var})
   {$XSGN{NULL0}=$XSGN{$var};
    $XSGN{NULL0}=~s|<%ID%>|$null|;
    $XSGN{NULL}=~s|<#$var#>|$XSGN{NULL0}|;
    next;
  }}}

  # VYTRHNUTIE PEVNYCH LINIEK NA PODPORTALY
  if ($env{URL_IDcat})
  {
   main::_log("i have URL_IDcat true");
   my $var;
   foreach (sort keys %env)
   {
    $_=~/^URL_IDcat_(.*)/ && do
    {
     main::_log("search $1 - $db0_line{IDcategory}");
     my $null=$1;$var=$env{'URL_IDcat_'.$null} if $db0_line{IDcategory}=~/^$null/;
    };
   }
   $XSGN{NULL}=~s|<%URL%>|$var|g if $var;
  }


  $XSGN{TMP}=~s|<#LINE#>|$XSGN{NULL}<#LINE#>|;
 }

 if (!$env{views})
 {
  $XSGN{TMP}=$XSGN{NOT_FOUND};
  return 1;
 }

 $env{page_from}=$env{page}-10;
 $env{page_from}=0 if $env{page_from} < 0;
 $env{page_to}=$env{page}+10;
 $env{page_to}=$main::FORM{a400mlistpages} if $env{page_to} > $main::FORM{a400mlistpages};

 if ($main::FORM{a400mlistpages})
 {
  $XSGN{TMP}=~s|<#PAGING#>|$XSGN{PAGING}|g;
 }

 for ($env{page_from}..$env{page_to}-1)
 {
  $XSGN{NULL}=$XSGN{NUM};
  $XSGN{NULL}=~s|<%url%>|a400mlistpage=$_\&a400mlistpages=$main::FORM{a400mlistpages}&keywords=$env{keywords}|g;
  $XSGN{NULL}=~s|<%NUM%>|$_+1|eg;
  $XSGN{TMP}=~s|<#NUM#>|$XSGN{NULL}<#NUM#>|g;
 }


if ($env{views}<$env{to})
{
   my $nextpage=$env{page}+1;
	$XSGN{NULL}=$XSGN{NEXT};
	$XSGN{NULL}=~s|<%url%>|keywords=$env{keywords}&a400mlistpage=$nextpage&a400mlistpages=$main::FORM{a400mlistpages}&a400mlistno=$main::FORM{a400mlistno}|g;
 	$XSGN{TMP}=~s|<#NEXT#>|$XSGN{NULL}|;
	$XSGN{TMP}=~s|<%PAGE%>|$env{page}|g;
 }

if ($env{page}>0)
{
   my $prevpage=$env{page}-1;
	$XSGN{NULL}=$XSGN{PREV};
	$XSGN{NULL}=~s|<%url%>|keywords=$env{keywords}&a400mlistpage=$prevpage&a400mlistpages=$main::FORM{a400mlistpages}&a400mlistno=$main::FORM{a400mlistno}|g;
 	$XSGN{TMP}=~s|<#PREV#>|$XSGN{NULL}|;
	$XSGN{TMP}=~s|<%PAGE%>|$env{page}|g;
 }

 $XSGN{TMP}=~s|<%URL%>|$env{URL}|g;
 $XSGN{TMP}=~s|<%NO%>|$main::FORM{a400mlistno}|g;


 return 1}

1;
