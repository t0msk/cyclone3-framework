#!/usr/bin/perl
# USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;

use App::020::_init;
use App::160::_init;
use App::510::_init;
use TOM::Text::format;

=head1 NAME

510-video_cat_list.0.mdl

=cut

=head1 DESCRIPTION

List of folders and items

=cut

=head1 INPUTS

=over

=item *

B<video_cat.ID> - ID of video_cat

=item *

B<keywords> - filter by defined keywords

=item *

B<status> - default 'Y'

=item *

B<sql_order_by> - default 'ID_charindex'

=item *

B<sql_limit> - SQL limit

=back

=cut


sub execute
{
	my %env=@_;
	Tomahawk::GetXSGN('-convertvars'=>1) || return undef;
	
	delete $env{'ID_charindex'};
	$env{'sql_limit'}=~s|^,|0,|;$env{'sql_limit'}=~s|,$|,10|;
	$env{'sql_limit'}=500 unless $env{'sql_limit'};
	$env{'sql_order_by'}='name ASC' unless $env{'sql_order_by'};
	
	my $from;
	my $sql_where;
	
	# language
	$sql_where.="lng='$env{'lng'}' ";
	
	# status
	if ($env{'status'})
	{
		$XSGN{'TMP'}=~s|<%required_status%>|$env{'status'}|g;
		$sql_where.="AND status IN ('".(join "','", split('',$env{'status'}))."') ";
	}
	else
	{
		$sql_where.="AND status='Y' ";
	}
	
	
	# find ID LIKE *
	if ($env{'video_cat.ID'}=~s/\*$//)
	{
		my $cat_sql=qq{
					SELECT
						ID_charindex
					FROM
						`$App::510::db_name`.a510_video_cat
					WHERE
						ID=$env{'video_cat.ID'}
					LIMIT 1
		};
		$env{'video_cat.ID*'} = qq{
			SELECT
				ID
			FROM
				`$App::510::db_name`.a510_video_cat
			WHERE
				ID_charindex LIKE CONCAT(($cat_sql),"%") AND
				lng='$env{'lng'}' AND
				status IN ('Y','N','L')
		};
		#TOM::Database::SQL::execute($cat_sql,'log'=>1);
	}
	
	
	if ($env{'video_cat.ID'})
	{
		$XSGN{'TMP'}=~s|<%ID%>|$env{'video_cat.ID'}|g;
		
		my %data=App::020::SQL::functions::get_ID(
			'db_h'    => 'main',
			'db_name' => $App::510::db_name,
			'tb_name' => 'a510_video_cat',
			'ID'      => $env{'video_cat.ID'},
			'columns' => 
			{
				'ID_charindex' => 1
			}
		);
		if ($data{'ID'})
		{
			$env{'ID_charindex'}=$data{'ID_charindex'}.':';
		}
		else
		{
			main::_log("can't find video_cat.ID='$data{'ID'}'",1);
			return undef;
		}
		
		my $path_;
		foreach my $node (App::020::SQL::functions::tree::get_path(
			$env{'video_cat.ID'},
			'db_h'    => 'main',
			'db_name' => $App::510::db_name,
			'tb_name' => 'a510_video_cat'
		))
		{$path_.='/'.$node->{'name'};}
		$path_=~s|^/||;
		
		$XSGN{'TMP'}=~s|<%location%>|$path_|g;
		
		if (!$env{'video_cat.ID*'})
		{
			# add parent as first folder item :))
			my %db0_line=App::020::SQL::functions::tree::get_parent_ID
			(
				'ID' => $env{'video_cat.ID'},
				'db_h' => 'main',
				'db_name' => $App::510::db_name,
				'tb_name' => 'a510_video_cat',
				'columns' => {'*' => 1,}
			);
			if ($db0_line{'ID'})
			{
				main::_log('adding parent');
				$XSGN{'NULL'}=$XSGN{'ITEM'};
				
				$XSGN{'NULL'}=~s|<%ID%>|$db0_line{'ID'}|g;
				$XSGN{'NULL'}=~s|<%db_name%>|..|g;
				$XSGN{'NULL'}=~s|<%folder%>|P|g;
				
				$XSGN{'TMP'}=~s|<#item#>|$XSGN{'NULL'}|;
			}
			else
			{
				$XSGN{'NULL'}=$XSGN{'ITEM'};
				
				$XSGN{'NULL'}=~s|<%ID%>||g;
				$XSGN{'NULL'}=~s|<%db_name%>|..|g;
				$XSGN{'NULL'}=~s|<%folder%>|P|g;
				
				$XSGN{'TMP'}=~s|<#item#>|$XSGN{'NULL'}|;
			}
		}
	}
	
	
	
	
	#
	# LISTING OF FOLDERS
	#
	
	
	
	my $sql=qq{
		SELECT
			*
		FROM
			`$App::510::db_name`.a510_video_cat
		WHERE
			$sql_where AND
			ID_charindex LIKE '$env{'ID_charindex'}___'
		ORDER BY
			ID_charindex
	};
	
	my @path;
	my @path_url;
	
	my %charindex_ID;
	
	my $level;
	my $level_prev;
	my $level_next;
	
	my %sth0=TOM::Database::SQL::execute($sql,'log'=>1,'slave'=>1);
	if ($sth0{'sth'} && !$env{'video_cat.ID*'})
	{
		
		while (my %db0_line=$sth0{'sth'}->fetchhash())
		{
			$charindex_ID{$db0_line{'ID_charindex'}}=$db0_line{'ID'};
			my $dbg=$db0_line{'ID_charindex'};
			$dbg=~s|^(.*?)(.{0,4})$|\1|;
			$db0_line{'ID_parent'}=$charindex_ID{$dbg};
			
			$XSGN{'NULL'}=$XSGN{'ITEM'};
			
			$XSGN{'NULL'}=~s|<%db_(.*?)%>|$db0_line{$1}|g;
			
			$XSGN{'NULL'}=~s|<%ID%>|$db0_line{'ID'}|g;
			$XSGN{'NULL'}=~s|<%ID_entity%>|$db0_line{'ID_entity'}|g;
			$XSGN{'NULL'}=~s|<%ID_parent%>|$db0_line{'ID_parent'}|g;
			$XSGN{'NULL'}=~s|<%folder%>|Y|g;
			
			$XSGN{'TMP'}=~s|<#item#>|$XSGN{'NULL'}|;
		}
		
	}
	else
	{
		main::_log("can't select");
	}
	
	
	
	#
	# LISTING OF ITEMS
	#
	
	if ($env{'keywords'}=~/^\d\d\d\d-\d\d-\d\d$/)
	{
		$sql_where.=" AND DATE(datetime_rec_start)='$env{keywords}' ";
	}
	elsif ($env{'keywords'}=~/^\d\d\d\d-\d\d$/)
	{
		$sql_where.=" AND DATE(datetime_rec_start) LIKE '$env{keywords}%' ";
	}
	elsif ($env{'keywords'})
	{
		$sql_where.=" AND (";
		foreach (split(' ',$env{'keywords'}))
		{
			next unless $_;
			$sql_where.="(name LIKE '%$_%' OR part_name LIKE '%$_%') AND ";
		}
		$sql_where=~s|AND $||;
		$sql_where.=") ";
	}
	
	# WHERE CATEGORY
	my $where_category;
	$where_category="AND ID_category='$env{'video_cat.ID'}'" if $env{'video_cat.ID'};
	$where_category="AND ID_category IN ($env{'video_cat.ID*'})" if $env{'video_cat.ID*'};
	$where_category="" unless $env{'video_cat.ID'};
	if (!$env{'video_cat.ID'} && !$env{'video_cat.ID*'}){$where_category="AND ID_category=0";}
	
	my $sql=qq{
		SELECT
			*
		FROM
			`$App::510::db_name`.a510_video_view
		WHERE
			(
				ID_format=$App::510::video_format_original_ID
				OR ID_format IS NULL
			) AND
			$sql_where
			$where_category
		GROUP BY
			ID_entity_video
		ORDER BY
			$env{'sql_order_by'}, datetime_rec_start DESC, datetime_create DESC
		LIMIT
			$env{'sql_limit'}
	};
	
	my %sth0=TOM::Database::SQL::execute($sql,'log'=>1,'slave'=>1);
	if ($sth0{'sth'})
	{
		while (my %db0_line=$sth0{'sth'}->fetchhash())
		{
			$XSGN{'NULL'}=$XSGN{'ITEM'};
			
			$XSGN{'NULL'}=~s|<%db_(.*?)%>|$db0_line{$1}|g;
			
			my $rating5=int(($db0_line{'rating'}/20)+0.5);
			$XSGN{'NULL'}=~s|<%rating5%>|$rating5|g;
			
			my $datetime_rec_start=$db0_line{'datetime_rec_start'};
#				$datetime_rec_start=~s|:\d\d$||;
			
			$XSGN{'NULL'}=~s|<%ID%>|$db0_line{'ID_video'}|g;
			$XSGN{'NULL'}=~s|<%ID_entity%>|$db0_line{'ID_entity_video'}|g;
			$XSGN{'NULL'}=~s|<%datetime_rec_start%>|$datetime_rec_start|g;
			
			my %owner=App::301::authors::get_author($db0_line{'posix_owner'});
			$XSGN{'NULL'}=~s|<%owner_(.*?)%>|$owner{$1}|g;
			
			# check relations
			my $relation=(App::160::SQL::get_relations(
				'db_name' => $App::510::db_name,
				'l_prefix' => 'a510',
				'l_table' => 'video',
				'l_ID_entity' => $db0_line{'ID_entity_video'},
				'status' => "Y"
				))[0];
			if ($relation->{'ID'})
			{
				$XSGN{'NULL'}=~s|<%relation_status%>|Y|g;
			}
			
			# check relations
			if ($db0_line{'video_keywords'})
			{
				$XSGN{'NULL'}=~s|<%keywords_status%>|Y|g;
			}
			
			if ($db0_line{'ID_part'})
			{
				
				my $relation=(App::160::SQL::get_relations(
					'db_name' => $App::510::db_name,
					'l_prefix' => 'a510',
					'l_table' => 'video_part',
					'l_ID_entity' => $db0_line{'ID_part'},
					'rel_type' => 'thumbnail',
					'r_db_name' => $App::501::db_name,
					'r_prefix' => 'a501',
					'r_table' => 'image',
					'limit' => 1
				))[0];
				if ($relation->{'ID'})
				{
					$XSGN{'NULL'}=~s|<%image.ID%>|$relation->{'r_ID_entity'}|g;
					
					my $sql=qq{
						SELECT
							*
						FROM
							`$App::501::db_name`.a501_image_view AS image
						WHERE
							image.ID_entity_image = $relation->{'r_ID_entity'} AND
							image.status='Y' AND
							image.ID_format = '$App::501::image_format_thumbnail_ID'
						LIMIT 1
					};
					my %sth1=TOM::Database::SQL::execute($sql,'quiet'=>1,'slave'=>1);
					if (my %db1_line=$sth1{'sth'}->fetchhash())
					{
						$XSGN{'NULL'}=~s|<%image.db_(.*?)%>|$db1_line{$1}|g;
					}
					
					my $sql=qq{
						SELECT
							*
						FROM
							`$App::501::db_name`.a501_image_view AS image
						WHERE
							image.ID_entity_image = $relation->{'r_ID_entity'} AND
							image.status='Y' AND
							image.ID_format = '$App::501::image_format_ico_ID'
						LIMIT 1
					};
					my %sth1=TOM::Database::SQL::execute($sql,'quiet'=>1,'slave'=>1);
					if (my %db1_line=$sth1{'sth'}->fetchhash())
					{
						my $uri=$tom::H_a501.'/image/file/'.$db1_line{'file_path'};
						$XSGN{'NULL'}=~s|<%ico%>|$uri|;
					}
					
					my $sql=qq{
						SELECT
							*
						FROM
							`$App::501::db_name`.a501_image_view AS image
						WHERE
							image.ID_entity_image = $relation->{'r_ID_entity'} AND
							image.status='Y' AND
							image.ID_format = '$App::501::image_format_original_ID'
						LIMIT 1
					};
					my %sth1=TOM::Database::SQL::execute($sql,'quiet'=>1,'slave'=>1);
					if (my %db1_line=$sth1{'sth'}->fetchhash())
					{
						$XSGN{'NULL'}=~s|<%image.original.db_(.*?)%>|$db1_line{$1}|g;
					}
					
				}
				
			}
			
			# count parts
			my $sql=qq{
				SELECT
					COUNT(*) AS cnt
				FROM
					`$App::510::db_name`.a510_video_part
				WHERE
					ID_entity = $db0_line{'ID_entity_video'} AND
					status IN ('Y','N','L')
			};
			my %sth1=TOM::Database::SQL::execute($sql,'quiet'=>1,'slave'=>1);
			my %db1_line=$sth1{'sth'}->fetchhash();
			$XSGN{'NULL'}=~s|<%parts%>|$db1_line{'cnt'}|g;
			
			
			# count parts length
			my $sql=qq{
				SELECT
					TIME(SUM(file.length)) AS length
				FROM
					`$App::510::db_name`.a510_video_part AS video_part
				LEFT JOIN `$App::510::db_name`.a510_video_part_file AS file ON
				(
					file.ID_entity = video_part.ID AND
					file.ID_format = $App::510::video_format_full_ID
				)
				WHERE
					video_part.ID_entity = $db0_line{'ID_entity_video'} AND
					video_part.status IN ('Y','N','L')
			};
			my %sth1=TOM::Database::SQL::execute($sql,'quiet'=>1,'slave'=>1);
			my %db1_line=$sth1{'sth'}->fetchhash();
			$db1_line{'length'}='' if $db1_line{'length'} eq "00:00:00";
			$XSGN{'NULL'}=~s|<%length%>|$db1_line{'length'}|g;
			
			
			# count parts visits
			my $sql=qq{
				SELECT
					SUM(visits) AS visits
				FROM
					`$App::510::db_name`.a510_video_part AS video_part
				WHERE
					video_part.ID_entity = $db0_line{'ID_entity_video'}
			};
			my %sth1=TOM::Database::SQL::execute($sql,'quiet'=>1,'slave'=>1);
			my %db1_line=$sth1{'sth'}->fetchhash();
			$XSGN{'NULL'}=~s|<%visits%>|$db1_line{'visits'}|g;
			
			
			$XSGN{'NULL'}=~s|<%dimensions%>|$db0_line{'video_width'}x$db0_line{'video_height'}|g;
			
			
			$XSGN{'TMP'}=~s|<#item#>|$XSGN{'NULL'}|;
			
		}
		
	}
	else
	{
		main::_log("can't select");
	}
	
	
	
	return 1;
}

our $authors="roman.fordinal\@comsultia.com";

=head1 AUTHORS

Roman Fordinal (roman.fordinal@comsultia.com)

=cut

1;
