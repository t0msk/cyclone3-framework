#!/usr/bin/perl
# ????? - USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;

our $authors = "gregor\@webcom.sk";

sub execute
{
	my %env = @_;

	Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN
	if ($env{xt_xlng})
	{
		main::_log("using xlng transformation");
		Tomahawk::GetXLNG() || return undef; # retrieve language xml
		Tomahawk::XLNGtoXSGN(); # implement XLNG into XSGN
	}



	# - where
	# - Management IDcategory - IDcategory, IDcategory_exclude
	# - direction
	# - na konci moze byt subory
	# - LINE: LINE, LINE_last, LINE_selected, LINE_article
	# - moznost _config
	# - ? moznost zobrazovat namiesto kategorii - subory

=head1
	ak nie je zadane like z modulu
		kedy je cesta
		- ked je direction to
		- ked nie je zadany direction ale je kategoria
		kedy je sitemap
		- ked nie je ani direction ani kategoria
		- ked je direction from

	where
	 - db_where, pridava sa do selectu

	like
	 - ak sa like, posle ako parameter do modulu, v module sa uz nevyskladava
=cut

=head1
	db_
		SELECT db_select
		FROM a400_category
		WHERE
			db_where
				db_like
			db_active
			db_lng
			db_order_by
			db_limit
=cut

	# KONVERZIE
	$env{db_limit} = $env{limit} if $env{limit};
	$env{db_like} = $env{like} if $env{like};
	
	$env{db_IDcategory_exclude} = $env{db_IDcategory_ex} if $env{db_IDcategory_ex};
	$env{db_IDcategory_exclude} =~ s|'||g; $env{db_IDcategory_exclude} =~ s|,|;|g;
	
	$env{db_IDcategory_default} = $env{db_IDcategory_def} if $env{db_IDcategory_def};

	# NASTAVENIA
	# xt - hlt
	$env{xt_hlt_ID} = $env{xt_hlt_default} if exists $env{xt_hlt_ID} && !$env{xt_hlt_ID} && $env{xt_hlt_default};
	$env{xt_hlt_IDname} = $env{xt_hlt_default} if exists $env{xt_hlt_IDname} && !$env{xt_hlt_IDname} && $env{xt_hlt_default};
	
	# ak mam clanok - db_ID
	if ($env{db_ID})
	{
		main::_log("Mam clanok s db_ID $env{db_ID}");

		main::_log("
			SELECT IDcategory
			FROM $env{db_400}.a400
			WHERE ID='$env{db_ID}'
		");
		
		my $db_article = $main::DB{main}->Query("
			SELECT IDcategory
			FROM $env{db_400}.a400
			WHERE ID='$env{db_ID}'
		");

		my %db_article_line = $db_article->fetchhash;
		$env{db_IDcategory} = $db_article_line{IDcategory};
	}
	
	# informacie z _config pre url
	$env{db_400}=Tomahawk::Getmdlvar("400","db") unless $env{db_400};
	$env{db_400}=$TOM::DB{main}{name} unless $env{db_400};

	$env{db_400_url}=$env{db_400} unless $env{db_400_url};
	$env{a400_IDcategory_url}=Tomahawk::Getmdlvar("400",'IDcategory_url', db=>$env{db_400_url});

	my %IDcategory_url_hash = ( $env{a400_IDcategory_url}=~/([^\r\n;]+);([^\r\n]+)/g );

	# selekt
	$env{db_select} = "ID, name" unless $env{db_select};

	# order by
	$env{db_order_by} = "ORDER BY $env{db_order_by}" if $env{db_order_by};
	$env{db_order_by} = "ORDER BY ID ASC" unless $env{db_order_by};
	
	# limit
	$env{db_limit} = "LIMIT $env{db_limit}" if $env{db_limit};

	# defaultna kategoria
	$env{db_IDcategory} = $env{db_IDcategory_default} if $env{db_IDcategory_default};

	# IDcategory
	if (!$env{db_IDcategory} && !$env{db_where})
	{
		$env{db_IDcategory} = "%" unless $env{db_IDcategory};
	}


	# active
	$env{db_active} = "active='Y'" if not exists $env{db_active} || $env{db_active};

	# lng
	$env{db_lng} = "(lng='$env{lng}' OR lng='')" if not exists $env{db_lng} || $env{db_lng};

	# start level
	$env{db_startlevel} = "(length(ID)/2>=$env{db_startlevel})" if $env{db_startlevel};

	# VYSKLADANIE a UPRAVY
	# exclude kategorie
	if ($env{db_IDcategory_exclude})
	{
		$env{db_exclude} = ""; $env{db_exclude_like} = "";
		foreach (split ";", $env{db_IDcategory_exclude})
		{
			if ($_ =~ /[_%]$/)
			{
				$env{db_exclude_like} .= " AND " if $env{db_exclude_like}; $env{db_exclude_like} .= "ID not like '$_'";
			}
			else
			{
				$env{db_exclude} .= "," if $env{db_exclude}; $env{db_exclude} .= "'$_'";
			}
		}
		$env{db_exclude} = "ID not in ($env{db_exclude})" if $env{db_exclude};
		$env{db_exclude} .= " AND " if $env{db_exclude} && $env{db_exclude_like};
		$env{db_exclude} = "$env{db_exclude}$env{db_exclude_like}";
	}

	# podla db_direction
	if (!$env{db_like} && $env{db_IDcategory})
	{
		my $like_IDcategory = $env{db_IDcategory};
		$like_IDcategory .= "%" unless $like_IDcategory =~ /[_%]$/;

		$env{db_like} = "ID like '$like_IDcategory'";
	}

	# cele where
	$env{db_where} = $env{db_where} if $env{db_where};
		
	$env{db_where} .= " AND " if $env{db_where} && $env{db_like};
	$env{db_where} .= $env{db_like} if ($env{db_like});

	$env{db_where} .= " AND " if $env{db_where} && $env{db_exclude};
	$env{db_where} .= $env{db_exclude} if ($env{db_exclude});

	$env{db_where} .= " AND " if $env{db_where} && $env{db_active};
	$env{db_where} .= $env{db_active} if ($env{db_active});

	$env{db_where} .= " AND " if $env{db_where} && $env{db_lng};
	$env{db_where} .= $env{db_lng} if ($env{db_lng});
	




	# Idem uz pracovat - zacnem selektom kategorii
	main::_log("
		NOVE
		SELECT $env{db_select}
		FROM $env{db_400}.a400_category
		WHERE
			$env{db_where}
			$env{db_order_by}
			$env{db_limit}
	");
	
	my $db0 = $main::DB{main}->Query("
		SELECT $env{db_select}
		FROM $env{db_400}.a400_category
		WHERE
			$env{db_where}
			$env{db_order_by}
			$env{db_limit}
	");

	my $countline = 0; # sem si ukladam poradove cislo LINE
	my %levelCountline; # toto sluzi ako pocitadlo poloziek v ramci levelu
	my $numrows = $db0->numrows; # pocet riadkov

	my $firstLevel; 
	my $lastID; # podla neho si zistujem level v ktorom som
	$XSGN{TMP} =~ s/<#LIST#>/$XSGN{LIST}/; # vsetko davam rovno do TMP

	main::_log("Ziskal som zaznamy, prechadzam ich") if $numrows;

	# prechadzam zaznamy
	while (my %db0_line = $db0->fetchhash)
	{ 

		my $null; # toto je tmp premenna - aktualna polozka

		# rozhodnem sa aku bude mat formu
		$null = $XSGN{LINE};

		
		# exchanging links heading to external locations
		# $env{IDcategory_url_allow} = 1;
		my $url;
		if ($env{IDcategory_url_allow})
		{
			my $var;
			#main::_log("trying to fetch IDcategory url");
			foreach (reverse sort keys %IDcategory_url_hash)
			{
				#main::_log("comparing $db0_line{ID} against $_");
				if ($db0_line{ID}=~/^$_/)
				{
					#main::_log("redirecting db_line reading to $IDcategory_url_hash{$_} (IDcategory: $ID)");
					$url = $IDcategory_url_hash{$_};
					last;
				}
			}
			
		}

		# pripadne ak najdem Line s poradovym cislom
		$null = $XSGN{"LINE_$countline"} if (exists $XSGN{"LINE_$countline"});
		
		# ak je url linka na externu stranku
		if ($url=~/^http:/)
		{
			$null = $XSGN{LINE_out};
			$null = $XSGN{"LINE_out_level_$level"} if exists $XSGN{"LINE_out_level_$level"};
		}

		# posledna kategoria
		if ($countline>=$numrows && $env{db_direction} eq "to")
		{
			$null = $XSGN{LINE_last};
			$null = $XSGN{"LINE_last_level_$level"} if exists $XSGN{"LINE_last_level_$level"};
		}

		# vybrana kategoria - da novy line LINE_selected
		if ($db0_line{ID} eq $env{db_select_IDcategory})
		{
			$null = $XSGN{LINE_selected};
			$null = $XSGN{"LINE_selected_level_$level"} if exists $XSGN{"LINE_selected_level_$level"};
		}

		# vybrana kategoria - zmeni len existijuci line
		if
		(
			( $db0_line{ID} && $db0_line{ID} eq $env{xt_hlt_ID} )
			||
			( $db0_line{IDname} && $db0_line{IDname} eq $env{xt_hlt_IDname} )
		)
		{
			$null =~ s|<%HLT%>|$XSGN{HLT}|g;
		}
		else
		{
			$null =~ s|<%HLT%>||g;
		}

		# nahradim url
		$null=~s|<%url%>|$url|g;
		# ak sa nic nenahradilo, tak to zmazem
		if($null=~/<%url%>/){$XSGN{NULL}=~s|<%url%>||g;}

		# nazov kategorie
		#$null =~ s/<%NAME%>/$db0_line{name}/g; $null =~ s/<%name%>/$db0_line{name}/g;

		# zamenim premenne
		foreach (keys %db0_line) { $null =~ s|<%$_%>|$db0_line{$_}|g; }

		# ID kategorie
		$null =~ s/<%IDcategory%>/$db0_line{ID}/g if $db0_line{ID};

		# - nemam design k LINE_x (normalna situacia)
		if (exists $XSGN{"LINE_$countline"})
		{
			# pozrem sa, ci ho mozem nahradit
			# ak ano
			if ($XSGN{TMP} =~ /<#LINE_$countline#>/)
			{
				# ak je v LINE_x designe <#LINE#>, potom jednu <#LINE#> zrusim, lebo
				# - inak by tu boli dva priestory pre LINE a mohlo by to zhaluzit
				$XSGN{TMP} =~ s|<#LINE#>|| if ( $XSGN{"LINE_$countline"} =~ /<#LINE#>/ );

				$XSGN{TMP} =~ s|<#LINE_$countline#>|$null|g;
			}
			else
			{
				$XSGN{TMP} =~ s|<#LINE#>|$null|;
			}

		}
		else
		{
			$XSGN{TMP} =~ s|<#LINE#>|$null|;
		}

		$lastID = $ID;
	}
	
	return 1;
}

1;