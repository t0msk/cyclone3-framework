#!/bin/perl
# áéíóú - USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;


sub execute
{
 my %env=@_;
 Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN
 #Tomahawk::GetXLNG() || return undef; # NATIAHNEM XML LANGUAGE

 $env{URL}="?|?" unless $env{URL};

 if ($env{IDcategory})
 {
  if ($env{allow_subs}){$env{sel}="IDcategory LIKE '$env{IDcategory}%' AND"}
  else{$env{sel}="IDcategory='$env{IDcategory}' AND"}
 }

 if ($main::IAdm)
 {

 if ($env{IDcategories})
 {
  my @nullarr=split(",",$env{IDcategories});
  $env{sel}="";
  foreach (@nullarr)
  {
	$env{sel}.="IDcategory='$_' OR ";
  }
  $env{sel}=~s|...$||;
  $env{sel}="(".$env{sel}.")";
  $XSGN{TMP}=$env{sel}; return 1;
 }
 }

 #if (($env{where})&&(not $env{where}=~/and$/i)){$env{where}.=" AND"}
 if (($env{where})&&(not $env{where}=~/and$/i)){$env{where}.=" AND"}

# if (!$env{IDcategory}){$tom::ERR="nezadane IDcategory";return undef;}
# if ($env{allow_subs}){$env{sel}="IDcategory LIKE '$env{IDcategory}%'"}
# 	else{$env{sel}="IDcategory='$env{IDcategory}'"}

 $env{db_400}=Tomahawk::Getmdlvar("400","db") unless $env{db_400};
 $env{db_400}=$TOM::DB_name unless $env{db_400};

 $env{db_500}=Tomahawk::Getmdlvar("500","db") unless $env{db_500};
 $env{db_500}=$TOM::DB_name unless $env{db_500};

 $env{format_500}='t' unless $env{format_500};
 $env{$env{format_500}.'_hash'}=Tomahawk::Getmdlvar("500",$env{format_500}.'_hash',db=>$env{db_500});

 # OSETRENIE WHERE
 #if (($env{where})&&(not $env{where}=~/^and/i)){$env{where}="AND ".$env{where}}

 # ORDER BY
 $env{orderby}="starttime DESC" unless $env{orderby};
 my $var = (length($env{IDcategory})/2)+1;
 $env{orderby}=~s|priority|SUBSTRING(priority, $var, 1)|;

=head1
 $XSGN{TMP}="
	SELECT ID,title,subtitle,tiny,xrelated,link,starttime
	FROM $env{db_400}.a400
	WHERE	$env{sel}
		$env{where}
		AND starttime<$tom::time_current
		AND (endtime>$tom::time_current OR endtime=0)
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	ORDER BY $env{orderby} LIMIT 1"; return 1;
=cut
 my %db0_line;

 #Tomahawk::debug::log(4,$var);
 my $db0=$main::DBH->Query("
	SELECT ID,title,subtitle,tiny,xrelated,link,starttime,IDcategory,visits
	FROM $env{db_400}.a400
	WHERE	$env{sel}
		$env{where}
		starttime<$tom::time_current
		AND (endtime>$tom::time_current OR endtime=0)
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	ORDER BY $env{orderby} LIMIT 1");

 if (not %db0_line=$db0->FetchHash())
 {
  #Tomahawk::debug::log(4,"dalsi");
  my $db0=$main::DBH->Query("
	SELECT ID,title,subtitle,tiny,xrelated,link,starttime,IDcategory,visits
	FROM $env{db_400}.a400_arch
	WHERE	$env{sel}
		$env{where}
		starttime<$tom::time_current
		AND (endtime>$tom::time_current OR endtime=0)
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	ORDER BY $env{orderby} LIMIT 1");
  if (not %db0_line=$db0->FetchHash())
  {
   # tuto vyskocim z modulu
	 if($env{return_null} eq 1){$XSGN{TMP}="";}
  }
 }

 if (%db0_line)
 {
  my $var=$db0_line{ID};
  if ($db0_line{link})
  {
   my $db0=$main::DBH->Query("
	(SELECT ID,title,subtitle,tiny,xrelated,link,IDcategory,visits
	FROM $env{db_400}.a400
	WHERE	ID='$var'
		AND starttime<$tom::time_current
		AND ((endtime>$tom::time_current) OR (endtime=0))
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	LIMIT 1)
	UNION ALL
	(SELECT ID,title,subtitle,tiny,xrelated,link,IDcategory,visits
	FROM $env{db_400}.a400
	WHERE	ID='$var'
		AND starttime<$tom::time_current
		AND ((endtime>$tom::time_current) OR (endtime=0))
		AND active='Y'
		AND (lng='$env{lng}' OR lng='')
	LIMIT 1)
	LIMIT 1");
   if (%db0_line=$db0->fetchhash()){Tomahawk::debug::log(9,"link $var=$db0_line{ID}");}
   else {$tom::ERR="k clanku $var som nenasiel fcnu linku :(";return undef;}
  }

  $XSGN{TMP}=~s|<%ID%>|$db0_line{ID}|g;
  $XSGN{TMP}=~s|<%VISITS%>|$db0_line{visits}|g;

  if (($env{title_cut})&&(length($db0_line{title})>$env{title_cut}))
  {$db0_line{title}=substr($db0_line{title}, 0, $env{title_cut});$db0_line{title}=~s|(.*) .*?$|$1...|;}
  $XSGN{TMP}=~s|<%TITLE%>|$db0_line{title}|g;

  if (($env{tiny_cut})&&(length($db0_line{tiny})>$env{tiny_cut}))
  {$db0_line{tiny}=substr($db0_line{tiny}, 0, $env{tiny_cut});$db0_line{tiny}=~s|(.*) .*?$|$1...|;}
  $XSGN{TMP}=~s|<%TINY%>|$db0_line{tiny}|g;

  if (($env{subtitle_cut})&&(length($db0_line{subtitle})>$env{subtitle_cut}))
  {$db0_line{subtitle}=substr($db0_line{subtitle}, 0, $env{subtitle_cut});$db0_line{subtitle}=~s|(.*) .*?$|$1...|;}
  $XSGN{TMP}=~s|<%SUBTITLE%>|$db0_line{subtitle}|g;

#=head1
  while ($db0_line{xrelated}=~s|<VAR id="(.*?)" value="(.*?)" />||)
  {
   my $var=$1;
   my $null=$2;
#   Tomahawk::debug::log(0," $var = $null");
   $var=~/^a500$/ && do
   {
    $null=sprintf('%07d',$null);
    $null=~/^(....)/i;my $var=$1;
    if ($env{$env{format_500}.'_hash'})
    {
     my $db0=$main::DBH->Query("
   	SELECT hash FROM $env{db_500}.a500
   	WHERE	ID='$null'
		AND format='$env{format_500}'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
     if (my @db0_line=$db0->fetchrow)
     {$null=$db0_line[0];}
    }
    $XSGN{NULL}=$XSGN{a500};
    $XSGN{NULL}=~s|<%ID%>|$tom::H_500/$var/$null-$env{format_500}.jpg|g;
    $XSGN{TMP}=~s|<#a500#>|$XSGN{NULL}|g;
    next;
   };
   if (($XSGN{$var})&&($null))
   {
    $XSGN{NULL}=$XSGN{$var};
    $XSGN{NULL}=~s|<%ID%>|$null|;
    $XSGN{TMP}=~s|<#$var#>|$XSGN{NULL}|;
    next;
   }
  }

  # VYTRHNUTIE PEVNYCH LINIEK NA PODPORTALY
  if ($env{URL_IDcat})
  {my $var;foreach (sort keys %env)
  {$_=~/^URL_IDcat_(.*)/ && do {my $null=$1;$var=$env{'URL_IDcat_'.$null} if $db0_line{IDcategory}=~/^$null/;};}
  $XSGN{TMP}=~s|<%URL%>|$var|g if $var;}
  else{$XSGN{TMP}=~s|<%URL%>|$env{URL}|g;}

#=cut

=head1
  my $zeroid;
  if ($db0_line{xrelated}=~/<VAR id="a500" value="(.*?)" \/>/)
  {$zeroid=sprintf('%07d',$1);} else {$zeroid=sprintf('%07d',0);}
  $zeroid=~/^(....)/i;my $var=$1;
  if ($env{$env{format_500}.'_hash'})
  {
   my $db0=$main::DBH->Query("
   	SELECT hash FROM $env{db_500}.a500
   	WHERE	ID='$zeroid'
		AND format='$env{format_500}'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
   if (my @db0_line=$db0->fetchrow)
   {$zeroid=$db0_line[0];Tomahawk::debug::log(9,"hash $var/$zeroid-$env{format_500}.jpg");}
   else {Tomahawk::debug::log(9,"not hash $var/$zeroid-$env{format_500}.jpg");}
  }
  $XSGN{TMP}=~s|<%IMG%>|$tom::H_500/$var/$zeroid|g;

  if ($db0_line{xrelated}=~/<VAR id="a820" value="(.*?)" \/>/){my $var=$1;$XSGN{TMP}=~s|<%a820%>|$var|g;}
=cut


  # DATE & TIME
  if ($env{show_datetime})
  {
   my %env0=Utils::datetime::ctodatetime($db0_line{starttime},format=>1);
   if ($env{show_datetime} eq "1")
   {$XSGN{TMP}=~s|<%DATETIME%>|$env0{mday}.$env0{mom}.$env0{year} $env0{hour}:$env0{min}|g;}
   else
   {
    $XSGN{TMP}=~s|<%DAY%>|$env0{mday}|g;
    $XSGN{TMP}=~s|<%MONTH%>|$env0{mom}|g;
    $XSGN{TMP}=~s|<%YEAR%>|$env0{year}|g;
    $XSGN{TMP}=~s|<%HOUR%>|$env0{hour}|g;
    $XSGN{TMP}=~s|<%MINUTE%>|$env0{min}|g;
   }
  }



 }


 return 1}

1;
